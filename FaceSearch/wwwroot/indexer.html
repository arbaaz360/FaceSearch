<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Album Indexer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#22d3ee; }
    body { margin:0; font-family:"Segoe UI",system-ui; background:var(--bg); color:var(--text); }
    header { padding:16px 20px; border-bottom:1px solid #1f2937; display:flex; gap:12px; align-items:center; }
    main { padding:20px; display:grid; gap:16px; }
    .card { background:var(--card); border:1px solid #1f2937; border-radius:12px; padding:14px; display:grid; gap:10px; }
    label { display:block; color:var(--muted); margin-bottom:4px; }
    input[type=text] { width:100%; padding:8px 10px; border-radius:8px; border:1px solid #1f2937; background:#0b1221; color:var(--text); }
    .row { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:12px; }
    .btn { padding:10px 14px; border-radius:8px; border:1px solid #1f2937; background:var(--accent); color:#0b1221; font-weight:600; cursor:pointer; }
    .pill { padding:4px 10px; border-radius:999px; background:#1f2937; color:var(--muted); }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border-bottom:1px solid #1f2937; text-align:left; color:var(--text); }
    th { color:var(--muted); font-weight:600; }
    img.thumb { max-width:80px; max-height:80px; border-radius:6px; object-fit:cover; }
    ul { padding-left: 18px; margin: 0; color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <div style="font-size:18px;font-weight:700;">Album Indexer</div>
    <div id="status" class="pill">Idle</div>
  </header>
  <main>
    <div class="card">
      <div style="font-weight:600;">Seed directory</div>
      <div class="row">
        <div>
          <label>Directory path</label>
          <input id="dir" type="text" placeholder="C:\path\to\folder">
        </div>
        <div>
          <label>Album Id (optional)</label>
          <input id="album" type="text" placeholder="album id (or derive from folder name)">
        </div>
      </div>
      <div class="row">
        <div>
          <label><input id="derive" type="checkbox" checked> Derive album from leaf folder if album id empty</label>
        </div>
        <div>
          <label><input id="videos" type="checkbox"> Include videos</label>
        </div>
        <div>
          <label><input id="recursive" type="checkbox" checked> Recursive</label>
        </div>
      </div>
      <button class="btn" onclick="seed()">Seed</button>
      <div id="seedResult" class="pill"></div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; gap:10px;">
        <div style="font-weight:600;">Scan directory for unknown female faces (create review tasks)</div>
        <div class="pill" id="scanStatus">Idle</div>
      </div>
      <div class="row">
        <div>
          <label>Directory path</label>
          <input id="scanDir" type="text" placeholder="C:\path\to\folder">
        </div>
        <div>
          <label>Threshold (album match)</label>
          <input id="scanThreshold" type="text" value="0.72">
        </div>
        <div>
          <label>TopK</label>
          <input id="scanTopK" type="text" value="5">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Tags (comma-separated)</label>
          <input id="scanTags" type="text" value="aggregator,promediaimages">
        </div>
        <div>
          <label><input id="scanRecursive" type="checkbox" checked> Recursive</label>
        </div>
      </div>
      <button class="btn" onclick="scanDir()">Scan</button>
      <div id="scanResult" class="pill"></div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; gap:10px;">
        <div style="font-weight:600;">Indexed albums</div>
        <div class="pill" id="pager">page</div>
      </div>
      <div class="row">
        <div>
          <label>Skip</label>
          <input id="skip" type="text" value="0">
        </div>
        <div>
          <label>Take</label>
          <input id="take" type="text" value="10">
        </div>
      </div>
      <button class="btn" onclick="loadAlbums()">Load</button>
      <div id="albums"></div>
    </div>
  </main>
  <script>
    const apiBase = window.location.origin;
    async function seed(){
      const dir = document.getElementById('dir').value.trim();
      const album = document.getElementById('album').value.trim();
      const derive = document.getElementById('derive').checked;
      const videos = document.getElementById('videos').checked;
      const recursive = document.getElementById('recursive').checked;
      const payload = {
        directoryPath: dir,
        albumId: album || null,
        deriveAlbumFromLeaf: derive,
        includeVideos: videos,
        recursive: recursive
      };
      document.getElementById('status').textContent = 'Seeding...';
      try{
        const res = await fetch(`${apiBase}/api/index/seed-directory`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        document.getElementById('seedResult').textContent = res.ok ? `Seeded: upserts ${data.upserts}, matched ${data.matched}` : ('Error '+res.status);
        document.getElementById('status').textContent = 'Idle';
      }catch(err){
        document.getElementById('status').textContent = 'Error';
      }
    }
    async function scanDir(){
      const dir = document.getElementById('scanDir').value.trim();
      const threshold = parseFloat(document.getElementById('scanThreshold').value || '0.72');
      const topK = parseInt(document.getElementById('scanTopK').value || '5',10);
      const recursive = document.getElementById('scanRecursive').checked;
      const tagsRaw = document.getElementById('scanTags').value || '';
      const tags = tagsRaw.split(',').map(t=>t.trim()).filter(Boolean);

      document.getElementById('status').textContent = 'Scanning...';
      document.getElementById('scanStatus').textContent = 'Scanning...';
      try{
        const res = await fetch(`${apiBase}/api/faces/scan-directory`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ directoryPath: dir, threshold, topK, recursive, tags })
        });
        const data = await res.json();
        if(res.ok){
          document.getElementById('scanResult').textContent = `Scanned ${data.imagesScanned} imgs, faces ${data.facesDetected}, reviews ${data.reviewsCreated}, matched ${data.matchesAboveThreshold}${data.scanId ? ' (scanId ' + data.scanId + ')' : ''}`;
          if(data.scanId){
            pollStatus(data.scanId);
          }
        }else{
          document.getElementById('scanResult').textContent = `Error ${res.status}`;
        }
      }catch(err){
        document.getElementById('scanResult').textContent = 'Error';
      }finally{
        document.getElementById('status').textContent = 'Idle';
      }
    }
    async function pollStatus(scanId){
      const label = document.getElementById('scanResult');
      const pill = document.getElementById('scanStatus');
      let attempts = 0;
      const timer = setInterval(async ()=>{
        attempts++;
        try{
          const res = await fetch(`${apiBase}/api/faces/scan-status/${scanId}`);
          if(!res.ok) throw new Error();
          const d = await res.json();
          label.textContent = `Scan ${scanId}: ${d.processedFiles}/${d.totalFiles} files, faces ${d.facesDetected}, reviews ${d.reviewsCreated}, matched ${d.matchesAboveThreshold}, state=${d.state}`;
          pill.textContent = `Scan ${d.state} (${d.processedFiles}/${d.totalFiles})`;
          if(d.state === 'completed' || attempts > 120){
            clearInterval(timer);
            pill.textContent = 'Idle';
          }
        }catch(_){
          pill.textContent = 'Idle';
        }
      }, 1000);
    }
    async function loadAlbums(){
      const skip = parseInt(document.getElementById('skip').value || '0',10);
      const take = parseInt(document.getElementById('take').value || '10',10);
      document.getElementById('status').textContent = 'Loading albums...';
      try{
        const res = await fetch(`${apiBase}/api/albums?skip=${skip}&take=${take}`);
        const data = await res.json();
        renderAlbums(data);
        document.getElementById('status').textContent = 'Idle';
      }catch(err){
        document.getElementById('status').textContent = 'Error';
      }
    }
    function renderAlbums(data){
      const container = document.getElementById('albums');
      const items = data.items || [];
      document.getElementById('pager').textContent = `showing ${items.length} of ${data.total}`;
      if(items.length===0){ container.innerHTML = '<div class="pill">No albums</div>'; return; }
      let html = '<table><thead><tr><th>Album</th><th>Display</th><th>IG</th><th>Counts</th><th>Flags</th><th>Preview</th></tr></thead><tbody>';
      items.forEach(a=>{
        html += `<tr>
          <td>${a.albumId}</td>
          <td>${a.displayName||''}</td>
          <td>${a.instagramHandle||''}</td>
          <td>${a.imageCount} imgs / ${a.faceImageCount} face</td>
          <td>${a.suspiciousAggregator ? 'agg?' : ''} ${a.mergeCandidate ? 'merge?' : ''}</td>
          <td>${a.previewBase64 ? `<img class="thumb" src="${a.previewBase64}">` : ''}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    loadAlbums();
  </script>
</body>
</html>
